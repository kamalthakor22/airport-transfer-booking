<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kamal Thakor Pearson Airport Drop Booking</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #e0e0e0;
    }
    .container {
      display: flex;
      border: 2px solid #333;
      max-width: 1000px;
      margin: 20px auto;
      background-color: white;
    }
    .left, .right {
      padding: 20px;
      flex: 1;
      background: white;
      overflow-y: auto;
      max-height: 100vh;
    }
    .left {
      border-right: 2px solid #333;
    }
    h2 {
      margin-top: 0;
    }
    #calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      margin-top: 10px;
    }
    .day {
      padding: 8px;
      text-align: center;
      border: 1px solid #ccc;
      cursor: pointer;
    }
    .day.disabled {
      background-color: #f2f2f2;
      color: #aaa;
      cursor: not-allowed;
    }
    .day.available {
      background-color: #e6ffe6;
    }
    #time-slots button {
      margin: 5px;
      padding: 8px 12px;
      cursor: pointer;
    }
    #time-slots button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .selected-info {
      background: #f9f9f9;
      padding: 10px;
      border: 1px solid #ddd;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- LEFT PANE -->
    <div class="left">
      <h2>Select a Date & Time for your Booking</h2>

      <div class="selected-info">
        <p><strong>Selected Date:</strong> <span id="selected-date">None</span></p>
        <p><strong>Selected Time:</strong> <span id="selected-time">None</span></p>
      </div>

      <div id="calendar"></div>
      <h3>Available Time Slots</h3>
      <div id="time-slots"></div>

      <button id="book-btn" style="margin-top:15px;">Book</button>
      <div id="login-section">
        <button id="login-btn">Login with Google</button>
        <button id="logout-btn" style="display:none;">Logout</button>
      </div>
    </div>

    <!-- RIGHT PANE -->
    <div class="right">
      <h2>Kamal Thakor<br/>Pearson Airport Drop Booking</h2>
      <p>Need a reliable and comfortable ride to Toronto Pearson Airport? Iâ€™ve got you covered!</p>
      <ul>
        <li>âœ… Private 5-Seater SUV</li>
        <li>Fits 3 passengers comfortably with:</li>
        <ul>
          <li>3 large suitcases</li>
          <li>3 small carry-ons</li>
        </ul>
      </ul>
      <p>ðŸ’° Payment: Cash</p>
      <p>ðŸ’° Affordable Flat Rate: Based on the location (call +1-xxx-xxx-xxxx)</p>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      addDoc,
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      signOut,
      onAuthStateChanged,
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // ðŸ”‘ Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBA4r1N4L_GwTrVrKku3lFYuj1gZIy-45w",
      authDomain: "ajaxairporttransfer.firebaseapp.com",
      projectId: "ajaxairporttransfer",
      storageBucket: "ajaxairporttransfer.firebasestorage.app",
      messagingSenderId: "664561343575",
      appId: "1:664561343575:web:3132b18dfa6ba41118d712"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // --- Generate 2h30m increments ---
    function generateTimeSlots(start = 9, end = 18, stepHours = 2, stepMinutes = 30) {
      let slots = [];
      let current = new Date();
      current.setHours(start, 0, 0, 0);

      const endTime = new Date();
      endTime.setHours(end, 0, 0, 0);

      while (current < endTime) {
        let h = current.getHours().toString().padStart(2, "0");
        let m = current.getMinutes().toString().padStart(2, "0");
        slots.push(`${h}:${m}`);
        current.setMinutes(current.getMinutes() + (stepHours * 60 + stepMinutes));
      }
      return slots;
    }

    const allSlots = generateTimeSlots();

    // --- Calendar rendering ---
    async function renderCalendar() {
      const bookingsRef = collection(db, "bookings");
      const snapshot = await getDocs(bookingsRef);
      const bookings = snapshot.docs.map(doc => doc.data());

      const today = new Date();
      today.setHours(0,0,0,0);

      const bookedByDate = {};
      bookings.forEach(b => {
        if (!bookedByDate[b.date]) bookedByDate[b.date] = [];
        bookedByDate[b.date].push(b.time);
      });

      const calendarEl = document.getElementById("calendar");
      calendarEl.innerHTML = "";

      const now = new Date();
      const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
      const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0);

      for (let d = monthStart; d <= monthEnd; d.setDate(d.getDate() + 1)) {
        const dateStr = d.toISOString().split("T")[0];
        const div = document.createElement("div");
        div.className = "day";
        div.textContent = d.getDate();

        if (d < today) {
          div.classList.add("disabled");
        } else {
          const booked = bookedByDate[dateStr] || [];
          if (booked.length >= allSlots.length) {
            div.classList.add("disabled");
          } else {
            div.classList.add("available");
            div.addEventListener("click", () => selectDate(dateStr, booked));
          }
        }
        calendarEl.appendChild(div);
      }
    }

    function selectDate(dateStr, booked) {
      const timeContainer = document.getElementById("time-slots");
      timeContainer.innerHTML = "";
      allSlots.forEach(slot => {
        const btn = document.createElement("button");
        btn.textContent = slot;
        btn.disabled = booked.includes(slot);
        btn.onclick = () => {
          document.getElementById("selected-date").textContent = dateStr;
          document.getElementById("selected-time").textContent = slot;
        };
        timeContainer.appendChild(btn);
      });
    }

    // --- Booking ---
    document.getElementById("book-btn").addEventListener("click", async () => {
      const date = document.getElementById("selected-date").textContent;
      const time = document.getElementById("selected-time").textContent;
      if (date === "None" || time === "None") {
        alert("Please select a date and time first.");
        return;
      }
      if (!auth.currentUser) {
        alert("Please log in to book.");
        return;
      }
      await addDoc(collection(db, "bookings"), {
        date, time, user: auth.currentUser.uid
      });
      alert("Booking confirmed!");
      location.reload();
    });

    // --- Auth ---
    document.getElementById("login-btn").addEventListener("click", () => {
      signInWithPopup(auth, provider);
    });

    document.getElementById("logout-btn").addEventListener("click", () => {
      signOut(auth);
    });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        document.getElementById("login-btn").style.display = "none";
        document.getElementById("logout-btn").style.display = "inline";
      } else {
        document.getElementById("login-btn").style.display = "inline";
        document.getElementById("logout-btn").style.display = "none";
      }
    });

    renderCalendar();
  </script>
</body>
</html>
