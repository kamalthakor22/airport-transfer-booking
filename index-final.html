<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pearson Airport Drop Booking</title>

<!-- Styles -->
<style>
  :root{
    --blue:#0b79d0;
    --blue-strong:#0077cc;
    --muted:#f3f4f6;
    --card-bg: #fff;
  }
  body{
    margin:0;
    font-family: Arial, sans-serif;
    background:#ccc;
    padding:20px;
    display:flex;
    justify-content:center;
  }

  /* Container / Card look */
  .container{
    max-width:1200px;
    width:100%;
    height:90vh;
    display:flex;
    background:var(--card-bg);
    border-radius:10px;
    overflow:hidden;
    border:2px solid #999;
    box-shadow:0 6px 24px rgba(0,0,0,0.12);
  }

  .left, .right {
    padding:30px;
    box-sizing:border-box;
    height:100%;
    overflow-y:auto;
    padding-bottom:20px; /* make last line visible */
  }

  .left{
    flex:0 0 400px;
    border-right:1px solid #eee;
    background:var(--card-bg);
  }
  .right{
    flex:1;
    background:var(--card-bg);
  }

  /* responsive mobile portrait: stack */
  @media (max-width:768px) {
    .container{flex-direction:column; height:auto;}
    .left, .right {height:auto; max-height:none;}
    .left{border-right:none; border-bottom:1px solid #eee; max-height:40vh; overflow-y:auto;}
  }

  h1{font-size:1.8rem;margin:0 0 8px 0}
  .highlight{color:var(--blue-strong);font-weight:bold}
  .small{font-size:0.9rem;color:#666}

  /* Calendar specific - header looks like your screenshot */
  .calendar-card{
    width:100%;
    background:#fff;
    border-radius:10px;
    overflow:hidden;
    box-shadow:0 6px 18px rgba(0,0,0,0.06);
    border:1px solid #eee;
  }

  .cal-header{
    background:var(--blue);
    color:white;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:14px 18px;
    font-weight:600;
    font-size:18px;
  }
  .cal-nav-btn {
    background:#fff;
    color:var(--blue);
    border-radius:6px;
    width:34px;
    height:34px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    border: none;
    cursor:pointer;
    font-weight:700;
    box-shadow:0 2px 6px rgba(0,0,0,0.08);
  }
  .cal-nav-btn:disabled { opacity:0.45; cursor:not-allowed; }

  .cal-body {
    padding:16px;
    background: #fff;
  }

  .weekday-row {
    display:grid;
    grid-template-columns:repeat(7,1fr);
    gap:6px;
    margin-bottom:6px;
    color:#444;
    font-weight:600;
    font-size:0.85rem;
    text-align:center;
  }

  #calendar {
    display:grid;
    grid-template-columns:repeat(7,1fr);
    gap:8px;
  }

  .calendar-day {
    background:#fff;
    border-radius:10px;
    padding:10px 6px;
    text-align:center;
    cursor:pointer;
    border:1px solid #efefef;
    position:relative;
    font-weight:600;
    transition:all .12s;
  }
  .calendar-day:hover { background:#f0f8ff; border-color:#a6d0ff; transform: translateY(-2px); }
  .calendar-day.disabled { background:#f6f6f6; color:#aaa; cursor:not-allowed; pointer-events:none; border-color:#eee; transform:none; }
  .calendar-day.selected { background:var(--blue-strong); color:white; box-shadow:0 8px 22px rgba(0,0,0,0.12); }

  /* dot for available day */
  .calendar-day .dot {
    width:8px; height:8px; border-radius:50%;
    background:var(--blue-strong);
    position:absolute;
    left:50%; transform:translateX(-50%);
    bottom:6px;
  }

  /* Timeslots */
  .timeslot-grid {
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(110px,1fr));
    gap:10px;
    margin-top:12px;
  }
  .timeslot {
    border-radius:8px;
    padding:10px;
    text-align:center;
    cursor:pointer;
    border:1px solid #e8e8e8;
    background:#fff;
    transition:all .12s;
    font-weight:600;
  }
  .timeslot:hover { background:#f0f8ff; border-color:#a6d0ff; transform: translateY(-2px); }
  .timeslot.disabled { background:#f3f3f3; color:#999; cursor:not-allowed; transform:none; }
  .timeslot.selected { background:var(--blue-strong); color:#fff; box-shadow:0 8px 18px rgba(0,0,0,0.12); }

  /* form styling */
  input, textarea { width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; box-sizing:border-box; margin-bottom:12px; }
  label { display:block; margin-bottom:6px; font-weight:600; color:#333; }

  .primary { background:var(--blue-strong); color:white; border:none; padding:12px 18px; border-radius:8px; cursor:pointer; font-weight:700; }
  .primary[disabled]{ opacity:0.6; cursor:not-allowed; }

  /* Selection popup (top-left fixed) : 50% transparent, text fully visible */
  #selectionPopup {
    position:fixed;
    top:18px;
    left:18px; /* top-left */
    z-index:9999;
    min-width:240px;
    background: rgba(3,120,255,0.5); /* 50% transparent blue */
    color:#fff;
    padding:14px 16px;
    border-radius:10px;
    box-shadow: 0 10px 26px rgba(0,0,0,0.18);
    display:none;
    font-weight:700;
  }
  #selectionPopup h4{ margin:0 0 8px 0; font-size:14px; }
  #selectionPopup p{ margin:6px 0; font-weight:600; font-size:13px; }

  /* toast */
  #toast {
    position:fixed;
    right:18px;
    bottom:18px;
    z-index:10000;
    background:#222;
    color:#fff;
    padding:12px 16px;
    border-radius:8px;
    opacity:0;
    transform: translateY(12px);
    transition: opacity .25s, transform .25s;
  }
  #toast.show { opacity:1; transform: translateY(0); }

</style>

<!-- EmailJS SDK (required) -->
<script src="https://cdn.emailjs.com/dist/email.min.js"></script>
</head>
<body>

<!-- Container -->
<div class="container">

  <!-- LEFT PANE -->
  <div class="left">
    <p><strong>üìÜ Selected Date:</strong> <span id="chosenDate" class="highlight">Not selected</span></p>
    <p><strong>‚è∞ Selected Time:</strong> <span id="chosenTime" class="highlight">Not selected</span></p>
    <h1>Pearson Airport Drop Booking</h1>
    <p><strong>Total Time: 2 hr 30 min</strong></p>

    <p>Need a reliable and comfortable ride to Toronto Pearson Airport? I‚Äôve got you covered!</p>
    <p>‚úÖ Private 5-Seater SUV</p>
    <p>Fits 3 passengers comfortably with:</p>
    <ul>
      <li>3 large suitcases</li>
      <li>3 small carry-ons</li>
    </ul>

    <p>üí∞ Payment: Cash</p>
    <p>üí∞ Affordable Flat Rate: Based on the location (call +1 (289) 830-8942)</p>
    <p>üìç Pick-up Location: Ajax & surrounding areas</p>
    <p>üìç Drop-off: Toronto Pearson International Airport (YYZ)</p>
    <p class="small">üìÜ Available 7 Days a Week ‚Äì Early Morning to Late Night</p>
    <p class="small">üìù How to Book: Call/Text/WhatsApp +1 (289) 830-8942 or use this form.</p>
  </div>

  <!-- RIGHT PANE -->
  <div class="right">
    <!-- Calendar card -->
    <div class="calendar-card">
      <div class="cal-header">
        <button id="prevMonth" class="cal-nav-btn">&lt;</button>
        <div id="monthYear">Month Year</div>
        <button id="nextMonth" class="cal-nav-btn">&gt;</button>
      </div>

      <div class="cal-body">
        <div class="weekday-row">
          <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
        </div>
        <div id="calendar"></div>
      </div>
    </div>

    <!-- Timeslots -->
    <div style="margin-top:18px;">
      <div class="date-header">Select Time for Drop-Off</div>
      <div id="timeslotGrid" class="timeslot-grid"></div>
    </div>

    <!-- Booking form -->
    <div id="details" style="display:none; margin-top:18px;">
      <label for="name">Full Name</label>
      <input id="name" type="text" placeholder="Your full name" />

      <label for="phone">Phone Number</label>
      <input id="phone" type="text" placeholder="+1 (555) 555-5555" />

      <label for="email">Email</label>
      <input id="email" type="email" placeholder="you@example.com" />

      <label for="pickup">Pickup Location (Complete Address)</label>
      <textarea id="pickup" rows="2" placeholder="123 Street, City"></textarea>

      <label for="flight">Flight Name & Number</label>
      <input id="flight" type="text" placeholder="Airline - Flight #" />

      <label for="passengers"># of Passengers</label>
      <input id="passengers" type="number" min="1" max="10" />

      <label for="checkin"># of Check-In Baggage (Large)</label>
      <input id="checkin" type="number" min="0" />

      <label for="carryon"># of Carry-On Baggage (Small)</label>
      <input id="carryon" type="number" min="0" />
    </div>

    <div style="margin-top:12px;">
      <button id="bookBtn" class="primary" style="display:none;">Book</button>
    </div>
  </div>
</div>

<!-- Floating Booking Summary (top-left, semi-transparent) -->
<div id="selectionPopup" aria-live="polite">
  <h4>Booking Summary</h4>
  <p id="popupDate">Date: Not selected</p>
  <p id="popupTime">Time: Not selected</p>
  <p id="popupName"></p>
  <p id="popupPhone"></p>
  <p id="popupEmail"></p>
  <p id="popupStatus"></p>
</div>

<!-- Toast -->
<div id="toast">Booking saved and email sent ‚úÖ</div>

<!-- Firebase + app logic -->
<script type="module">
/* ------------- Firebase setup ------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
import { getFirestore, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBA4r1N4L_GwTrVrKku3lFYuj1gZIy-45w",
  authDomain: "ajaxairporttransfer.firebaseapp.com",
  projectId: "ajaxairporttransfer",
  storageBucket: "ajaxairporttransfer.firebasestorage.app",
  messagingSenderId: "664561343575",
  appId: "1:664561343575:web:3132b18dfa6ba41118d712"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const bookingsRef = collection(db, "bookings");

/* ------------- EmailJS setup ------------- */
/* You provided:
   service_id: service_y0kwolt
   template_id: template_a917qk4
   public_key: Vfj2HuweC5ZvJKMtx
*/
const EMAILJS_SERVICE = 'service_y0kwolt';
const EMAILJS_TEMPLATE = 'template_a917qk4';
const EMAILJS_PUBLIC_KEY = 'Vfj2HuweC5ZvJKMtx';

// initialize EmailJS (global emailjs provided by email.min.js)
if (window.emailjs) {
  try { window.emailjs.init(EMAILJS_PUBLIC_KEY); } catch(e) { /* already init possible */ }
} else {
  console.warn('EmailJS SDK not loaded. Emails will fail.');
}

/* ------------- DOM references ------------- */
const calendarEl = document.getElementById('calendar');
const monthYearEl = document.getElementById('monthYear');
const prevBtn = document.getElementById('prevMonth');
const nextBtn = document.getElementById('nextMonth');
const timeslotGrid = document.getElementById('timeslotGrid');
const detailsForm = document.getElementById('details');
const bookBtn = document.getElementById('bookBtn');

const chosenDateEl = document.getElementById('chosenDate');
const chosenTimeEl = document.getElementById('chosenTime');

const selectionPopup = document.getElementById('selectionPopup');
const popupDate = document.getElementById('popupDate');
const popupTime = document.getElementById('popupTime');
const popupName = document.getElementById('popupName');
const popupPhone = document.getElementById('popupPhone');
const popupEmail = document.getElementById('popupEmail');
const popupStatus = document.getElementById('popupStatus');

const toast = document.getElementById('toast');

const inputName = document.getElementById('name');
const inputPhone = document.getElementById('phone');
const inputEmail = document.getElementById('email');
const inputPickup = document.getElementById('pickup');
const inputFlight = document.getElementById('flight');
const inputPassengers = document.getElementById('passengers');
const inputCheckin = document.getElementById('checkin');
const inputCarryon = document.getElementById('carryon');

/* ------------- State ------------- */
let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();
let selectedDate = null;   // YYYY-MM-DD
let selectedTime = null;   // "H:MM AM/PM"
let bookedDates = [];      // dates with >= 22 bookings

/* ------------- Helpers ------------- */
function toDateStr(y,m,d){ return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; }

function showToast(msg){
  toast.textContent = msg || 'Booking saved and email sent ‚úÖ';
  toast.classList.add('show');
  setTimeout(()=> toast.classList.remove('show'), 4200);
}

/* ------------- Fetch bookings to calculate fully booked days ------------- */
async function fetchBookings(){
  try{
    const snap = await getDocs(bookingsRef);
    const counts = {};
    snap.docs.forEach(d => {
      const data = d.data();
      if (!data || !data.date) return;
      counts[data.date] = counts[data.date] ? counts[data.date]+1 : 1;
    });
    bookedDates = [];
    Object.keys(counts).forEach(dt => { if (counts[dt] >= 22) bookedDates.push(dt); });
  }catch(err){
    console.error('fetchBookings error', err);
    bookedDates = [];
  }
}

/* ------------- Calendar rendering (GitHub style) ------------- */
async function generateCalendar(){
  await fetchBookings();
  calendarEl.innerHTML = '';
  const first = new Date(currentYear, currentMonth, 1);
  const last = new Date(currentYear, currentMonth+1, 0);
  const startDay = first.getDay();
  const daysInMonth = last.getDate();

  monthYearEl.textContent = first.toLocaleString('default',{month:'long', year:'numeric'});

  // disable prev if current
  const today = new Date();
  prevBtn.disabled = (currentYear === today.getFullYear() && currentMonth === today.getMonth());

  // blanks for first week
  for (let i=0;i<startDay;i++){
    const blank = document.createElement('div');
    calendarEl.appendChild(blank);
  }

  for (let d=1; d<=daysInMonth; d++){
    const dayEl = document.createElement('div');
    dayEl.className = 'calendar-day';
    dayEl.innerText = d;
    const dateStr = toDateStr(currentYear, currentMonth+1, d);
    const dayDate = new Date(currentYear, currentMonth, d);
    // check past and fully booked
    const today0 = new Date(); today0.setHours(0,0,0,0);
    if (dayDate < today0 || bookedDates.includes(dateStr)){
      dayEl.classList.add('disabled');
    } else {
      const dot = document.createElement('div'); dot.className='dot';
      dayEl.appendChild(dot);
    }

    dayEl.addEventListener('click', ()=> {
      if (dayEl.classList.contains('disabled')) return;
      document.querySelectorAll('.calendar-day').forEach(c=>c.classList.remove('selected'));
      dayEl.classList.add('selected');
      selectedDate = dateStr;
      chosenDateEl.innerText = selectedDate;
      popupDate.innerText = `Date: ${selectedDate}`;
      selectionPopup.style.display = 'block';
      popupStatus.innerText = '';
      // reset time & form
      selectedTime = null;
      chosenTimeEl.innerText = 'Not selected';
      popupTime.innerText = 'Time: Not selected';
      detailsForm.style.display = 'none';
      bookBtn.style.display = 'none';
      // render times and then disable booked slots
      generateSlotsForDate(selectedDate);
      disableBookedSlots(selectedDate);
    });

    calendarEl.appendChild(dayEl);
  }
}

/* ------------- Timeslot generation (hourly 0..21) ------------- */
function generateSlotsForDate(dateStr){
  timeslotGrid.innerHTML = '';
  const now = new Date();
  const [y,m,d] = dateStr.split('-').map(Number);
  for (let h=0; h<=21; h++){
    const slotDate = new Date(y, m-1, d, h, 0, 0, 0);
    const hour12 = h % 12 === 0 ? 12 : h % 12;
    const ampm = h < 12 ? 'AM' : 'PM';
    const label = `${hour12}:00 ${ampm}`;

    const slotEl = document.createElement('div');
    slotEl.className = 'timeslot';
    slotEl.innerText = label;

    // disable if slot is less than now + 1 hour (only for same day)
    const isToday = (slotDate.toDateString() === new Date().toDateString());
    if (isToday && slotDate < new Date(now.getTime() + 60*60*1000)){
      slotEl.classList.add('disabled');
    }

    slotEl.addEventListener('click', ()=> {
      if (slotEl.classList.contains('disabled')) return;
      document.querySelectorAll('.timeslot').forEach(s=>s.classList.remove('selected'));
      slotEl.classList.add('selected');
      selectedTime = label;
      chosenTimeEl.innerText = selectedTime;
      popupTime.innerText = `Time: ${selectedTime}`;
      // reveal form and book button
      detailsForm.style.display = 'block';
      bookBtn.style.display = 'inline-block';
      // populate popup with any typed contact info
      popupName.innerText = inputName.value ? `Name: ${inputName.value}` : '';
      popupPhone.innerText = inputPhone.value ? `Phone: ${inputPhone.value}` : '';
      popupEmail.innerText = inputEmail.value ? `Email: ${inputEmail.value}` : '';
    });

    timeslotGrid.appendChild(slotEl);
  }
}

/* ------------- Disable already-booked times for the selected date ------------- */
async function disableBookedSlots(dateStr){
  try{
    const q = query(bookingsRef, where('date','==',dateStr));
    const snap = await getDocs(q);
    const bookedTimes = snap.docs.map(d=>d.data().time);
    document.querySelectorAll('.timeslot').forEach(el=>{
      if (bookedTimes.includes(el.innerText)){
        el.classList.add('disabled');
        // remove click handlers by replacing node
        const clone = el.cloneNode(true);
        el.parentNode.replaceChild(clone, el);
      }
    });
  }catch(err){
    console.error('disableBookedSlots error', err);
  }
}

/* ------------- Booking submit: Firestore write + EmailJS sends + UI updates ------------- */
bookBtn.addEventListener('click', async ()=> {
  if (!selectedDate || !selectedTime){
    alert('Please select a date and time first.');
    return;
  }

  const payload = {
    date: selectedDate,
    time: selectedTime,
    name: inputName.value || '',
    phone: inputPhone.value || '',
    email: inputEmail.value || '',
    pickup: inputPickup.value || '',
    flight: inputFlight.value || '',
    passengers: inputPassengers.value || '',
    checkin: inputCheckin.value || '',
    carryon: inputCarryon.value || '',
    createdAt: new Date().toISOString()
  };

  try{
    // Save booking to Firestore
    await addDoc(bookingsRef, payload);

    // Update popup details (confirmation)
    popupStatus.innerText = '‚úÖ Booking confirmed!';
    popupName.innerText = payload.name ? `Name: ${payload.name}` : '';
    popupPhone.innerText = payload.phone ? `Phone: ${payload.phone}` : '';
    popupEmail.innerText = payload.email ? `Email: ${payload.email}` : '';

    bookBtn.disabled = true;

    // Prepare EmailJS template params
    const templateParams = {
      from_name: payload.name || 'Guest',
      from_phone: payload.phone || '',
      customer_email: payload.email || '',
      selected_date: payload.date,
      selected_time: payload.time,
      pickup_location: payload.pickup || '',
      flight_info: payload.flight || '',
      to_email: payload.email || ''
    };

    // send to customer (if email available)
    try {
      if (payload.email && window.emailjs) {
        await window.emailjs.send(EMAILJS_SERVICE, EMAILJS_TEMPLATE, {
          ...templateParams,
          to_email: payload.email
        });
      }
    } catch(e){
      console.warn('EmailJS customer send failed', e);
    }

    // send to internal address
    try {
      if (window.emailjs) {
        await window.emailjs.send(EMAILJS_SERVICE, EMAILJS_TEMPLATE, {
          ...templateParams,
          to_email: 'kamalt@rocketmail.com'
        });
      }
    } catch(e){
      console.warn('EmailJS internal send failed', e);
    }

    // Toast confirmation
    showToast('Booking saved ‚Äî confirmation email(s) sent.');

    // Keep popup visible with confirmation, then auto-clear after 30s
    selectionPopup.style.display = 'block';
    setTimeout(()=> {
      clearPopupAndReset();
    }, 30000);

  }catch(err){
    console.error('booking save error', err);
    alert('Failed to save booking. Check console for details.');
  }
});

/* ------------- Clear UI & reset after confirmation ------------- */
function clearPopupAndReset(){
  selectionPopup.style.display = 'none';
  popupDate.innerText = 'Date: Not selected';
  popupTime.innerText = 'Time: Not selected';
  popupName.innerText = '';
  popupPhone.innerText = '';
  popupEmail.innerText = '';
  popupStatus.innerText = '';

  // reset selections and form
  selectedDate = null; selectedTime = null;
  chosenDateEl.innerText = 'Not selected';
  chosenTimeEl.innerText = 'Not selected';
  detailsForm.style.display = 'none';
  bookBtn.style.display = 'none';
  bookBtn.disabled = false;

  inputName.value=''; inputPhone.value=''; inputEmail.value=''; inputPickup.value=''; inputFlight.value='';
  inputPassengers.value=''; inputCheckin.value=''; inputCarryon.value='';

  // refresh calendar (to update fully-booked dots)
  generateCalendar();
}

/* ------------- Month nav ------------- */
prevBtn.addEventListener('click', ()=> {
  const today = new Date();
  if (currentYear === today.getFullYear() && currentMonth === today.getMonth()) return; // blocked
  currentMonth--;
  if (currentMonth < 0) { currentMonth = 11; currentYear--; }
  generateCalendar();
});
nextBtn.addEventListener('click', ()=> {
  currentMonth++;
  if (currentMonth > 11) { currentMonth = 0; currentYear++; }
  generateCalendar();
});

/* ------------- Init ------------- */
generateCalendar();

</script>

<!--
  ---------------------------
  EmailJS Template (recommended)
  ---------------------------
  Paste this into your EmailJS template editor (template_a917qk4)

  Subject:
    Booking Confirmation - Pearson Airport Drop

  HTML Body:
  <h2>‚úÖ New Booking - Pearson Airport Drop</h2>
  <p><strong>Name:</strong> {{from_name}}</p>
  <p><strong>Phone:</strong> {{from_phone}}</p>
  <p><strong>Email:</strong> {{customer_email}}</p>
  <p><strong>Date:</strong> {{selected_date}}</p>
  <p><strong>Time:</strong> {{selected_time}}</p>
  <p><strong>Pickup Location:</strong> {{pickup_location}}</p>
  <p><strong>Flight Info:</strong> {{flight_info}}</p>
  <hr/>
  <p>Please contact the customer to confirm pickup details.</p>
  <p style="color:#666;font-size:12px;">This email was generated by the Ajax Airport Transfer booking site.</p>

  Notes:
  - Use {{to_email}} in the "To" field when using dynamic recipient or send twice (we do two sends here).
  - Template variable names used in script: from_name, from_phone, customer_email, selected_date, selected_time, pickup_location, flight_info
-->

</body>
</html>
